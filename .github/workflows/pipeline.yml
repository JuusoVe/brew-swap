# Docs for the Azure Web Apps Deploy action: https://go.microsoft.com/fwlink/?linkid=2134798
# More GitHub Actions for Azure: https://go.microsoft.com/fwlink/?linkid=2135048

name: Homebrew Swap lint, test, deploy

on:
  push:
    branches:
      - main

jobs:
  build-lint-test:
    runs-on: ubuntu-latest
    env:
      JWT_SECRET: ${{ secrets.JWT_SECRET }}
      SG_EMAIL_SENDKEY: ${{ secrets.SG_EMAIL_SENDKEY }}
      TEST_MONGODB_URI: ${{ secrets.TEST_MONGODB_URI }}
      REACT_APP_GOOGLE_MAPS_API_KEY: ${{ secrets.REACT_APP_GOOGLE_MAPS_API_KEY }}
      REACT_APP_GOOGLE_MAPS_URI: ${{ secrets.REACT_APP_GOOGLE_MAPS_URI }}
    steps:
    # checkout the repo
    - name: 'Checkout Github Action'
      uses: actions/checkout@v2
    #set up Node
    - name: Set up Node.js version
      uses: actions/setup-node@v1
      with:
        node-version: '10.x'
    #install and lint backend
    - name: install and lint backend
      run: |
        npm install
        npm run lint
      working-directory: ./server
    #create .env for frontend build
    - name: create .env for frontend build
      run: | 
        echo REACT_APP_GOOGLE_MAPS_API_KEY=$REACT_APP_GOOGLE_MAPS_API_KEY >> .env
        cat .env
      working-directory: ./client
    #install, lint, build front-end, then move to backend dir to serve
    - name: install, lint, build  frontend and move build-dir to backend-dir
      run: |
        npm install
        npm run lint
        cat .env
        npm run build:mv
      working-directory: ./client
    #run e2e tests
    - name: run e2e tests
      uses: cypress-io/github-action@v2
      with:
        start: npm run start:server
        wait-on: 'http://localhost:3001/api/test/health'
        working-directory: client
        spec: cypress/integration/homepage.spec.js
    #deploy to Azure with publish profile
    - name: deploy to Azure with publish profile
      uses: azure/webapps-deploy@v2
      with:
        app-name: homebrewswap
        publish-profile: ${{ secrets.AZUREAPPSERVICE_PUBLISHPROFILE_CD2404AA7C6A468F80DB209699E93E09 }}
        package: ./server
        







